---
title: 'Project3: Cartography'
output: 
  html_document: 
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

# Part1: Dollars spent by different countries on HIV or all diseases

```{r}

library(readr)
library(tidyverse)
library(OpenStreetMap)
library(mapview)
library(mapedit)
library(sf)
library(tidyverse)
library(janitor)
library(ggrepel)
library(rworldmap)
library(osmdata)
library(purrr)
library(transformr)
library(RColorBrewer)
library(dplyr)


world <- st_read("data/ne_110m_admin_0_countries.shp") %>% 
  clean_names()

sf::sf_use_s2(FALSE)

spending_2019 <- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>%
  filter(year == 2019)


spending_source <- spending_2019 %>%
  dplyr::select(
    source, contains(c("hiv", "mal", "tb", "ncd"))
  ) 


spending_long_hiv <- spending_source%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd"))) %>%
  mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  dplyr::select(-name) %>% 
  filter(disease=="hiv") %>% 
  group_by(source) %>% 
  summarize(expenditure_hiv = sum(value, na.rm = TRUE)) %>% 
  mutate(source=str_replace_all(source,"_"," ")) %>% 
  mutate(expenditure_hiv_millions=expenditure_hiv/1e6)

spending_long_alldiseases <- spending_source%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd"))) %>%
  mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  dplyr::select(-name) %>% 
  group_by(source) %>% 
  summarize(expenditure_alldiseases = sum(value, na.rm = TRUE))%>% 
  mutate(source=str_replace_all(source,"_"," "))%>% 
  mutate(expenditure_alldiseases_millions=expenditure_alldiseases/1e6)

data_Q1_hiv <-world  %>%
  left_join(spending_long_hiv, c("name_long"="source")) %>%
  rename(source=name) 

data_Q1_alldiseases <-world  %>%
  left_join(spending_long_alldiseases, c("name_long"="source")) %>% 
 rename(source=name) 

library(patchwork)

plot1<-ggplot() + 
coord_sf()+ 
  geom_sf(data = data_Q1_hiv,
                    aes(fill = expenditure_hiv_millions))+
  scale_fill_continuous(type = "viridis", limits = c(0, 15))+
  labs(title="All disease Expenditure") + 
  theme(legend.position = "none") 


plot2<-ggplot() + 
coord_sf()+ 
  geom_sf(data = data_Q1_alldiseases,
                    aes(fill = expenditure_alldiseases_millions))+theme_void()+
  scale_fill_continuous(type = "viridis", limits = c(0, 15))+
  labs(title="HIV Expenditure", fill = "USD (million)")

plot1 + plot2 + 
  plot_layout(ncol = 2)+ plot_annotation(
  title = 'Comparison of expenditure in treating HIV vs all diseases by different countries for year 2019',
  subtitle = 'Expenditure in  USD (millions)',
  caption = "Source: IHME Development Assistance for Health Database"
)

  
```
\
\ Dissecting down information on expenditure for all diseases for year 2019, looks like HIV has been the major contributor for expenses


```{r}


```
\ \

Looking at expenditure for all the diseases in the year 2019, the maximum expenditure in the range of 10-15 million is done by USA. Other countries in the range from 0-5 million include countries like Canda, Australia and China.


# Part2: Dollars received by countries

```{r}
  
spending_2015 <- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>%
  filter(year == 2015)


spending_recipient <- spending_2015 %>%
  dplyr::select(
    recipient_isocode, contains(c("hiv", "mal", "tb", "ncd"))
  )

spending_long_alldiseases_recipient <- spending_recipient%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd")), 
               names_to="name", values_to="value") %>%
  mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  dplyr::select(-name) %>% 
  group_by(recipient_isocode) %>% 
  summarize(expenditure_alldiseases = sum(value, na.rm = TRUE))%>% 
  mutate(expenditure_alldiseases_millions=expenditure_alldiseases/1e6)

data_Q2_alldiseases <-world  %>%
  left_join(spending_long_alldiseases_recipient, c("iso_a3"="recipient_isocode")) %>% 
  rename(recipient=iso_a3)
  

ggplot() + 
coord_sf()+ 
  geom_sf(data = data_Q2_alldiseases,
                    aes(fill = expenditure_alldiseases_millions))+theme_void()+
  labs(title="Money received by for treating all diseases in 2015",
       caption = "Source: IHME Development Assistance for Health Database") +
  scale_fill_continuous(name =  "Millions (USD)")
  
```
\
\ 
Looking at money received by different countries for year 2015, countries like India, some african countries (the maximum expenditure is in the range of 0-1 million), followed by south american countries.

# Part3: Map by gbd region

```{r}

library(rworldmap)

dQ3<-data_Q1_alldiseases %>% 
  group_by(region_wb) %>% 
  summarise(expenditure_alldiseases_millions=round(sum(expenditure_alldiseases_millions,
                                                 na.rm=T),1)) 



ggplot() + 
coord_sf()+ 
  geom_sf(data = dQ3,
                    aes(fill = expenditure_alldiseases_millions))+theme_void()+
  labs(title="Expenditure by GBD regions in treating all diseases for year 2015",
       caption = "Source: IHME Development Assistance for Health Database") + guides(fill=guide_legend(title='Millions (USD)'))

```
\
\
Looking at expenditure done by GBD regions at year 2015, maximum expenditure is done by North America, Europe and Russia. These regions spend in the range of 5-15 millions. 

# Part4: Money received by different countries across time

```{r}
  
spending_recipient_disease_time<- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>% 
  dplyr::select(recipient_country, year,contains(c("hiv", "mal", "tb", "ncd"))) %>% 
  mutate_at(vars(starts_with("hiv")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("mal")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("tb")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("ncd")),funs(as.numeric)) %>%   mutate(recipient_country=str_replace(recipient_country, "_"," "))


spending_recipient_all_disease_time <- spending_recipient_disease_time%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd")), 
               names_to = "name", values_to = "value") %>%
  mutate(disease = str_extract(name, "[^_]+")) %>%
  dplyr::select(-name) %>% 
  filter(value>1000 ) %>% 
  mutate(value_millions=value/1e6) %>% 
  distinct_all() %>% 
  dplyr::select(-value) %>% 
  group_by(recipient_country, year) %>% 
  summarise(expenditure_alldiseases = sum(value_millions, na.rm = TRUE)) %>% 
  ungroup() 


data_Q4_alldiseases_recipient <-world  %>%
  left_join(spending_recipient_all_disease_time, c("name_long"="recipient_country")) %>% 
  rename(source=name_sort)

ggplot() +
  geom_sf(
    data = world)+
  geom_sf(
    data = data_Q4_alldiseases_recipient,
    mapping = aes(fill = expenditure_alldiseases)
  ) + 
  gganimate::transition_states(year,
                                   transition_length = 1,
                                   state_length = 5)+
  labs(
    title = "Year: {closest_state}",
    subtitle = "Money received by different countries in millions (USD)"
  )+ 
  scale_fill_continuous(type = "viridis", limits = c(0, 1.5))+
  guides(fill = guide_legend(title =  "Million (USD)", 
                             label.position = "bottom",
                             title.position = "top",
                             nrow = 1))+
  theme(legend.position = "bottom")
  
  
```

\
\ Few countries from South Africa and India received lot of funding for treating diseases between 2005-2015. Then who were the generous donators, let's find it it out next.

# Part4 dig further: Money spent by different countries across time

```{r}

spending_source_disease_time<- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>% 
  dplyr::select(source, year,contains(c("hiv", "mal", "tb", "ncd"))) %>% 
  mutate_at(vars(starts_with("hiv")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("mal")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("tb")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("ncd")),funs(as.numeric)) %>% 
  clean_names() %>% 
  mutate(source=str_replace(source, "_"," "))


spending_source_all_disease_time <- spending_source_disease_time%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd")), 
               names_to = "name", values_to = "value") %>%
  #pivot_longer(!recipient_country, names_to = "name", values_to = "value") %>%
  #mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  dplyr::select(-name) %>% 
  filter(value>10000) %>% 
  mutate(value_millions=value/1e6) %>% 
  distinct_all() %>% 
  dplyr::select(-value) %>% 
  group_by(source, year) %>% 
  summarise(expenditure_alldiseases = sum(value_millions, na.rm = TRUE)) %>% 
  ungroup() 


data_Q4_alldiseases_source <-world  %>%
  left_join(spending_source_all_disease_time, c("name_long"="source")) %>% 
  rename(source=name_sort)

ggplot() +
  geom_sf(
    data = world)+
  geom_sf(
    data = data_Q4_alldiseases_source,
    mapping = aes(fill = expenditure_alldiseases)
  ) + 
  gganimate::transition_states(year,
                                   transition_length = 1,
                                   state_length = 5)+
  labs(
    title = "Year: {closest_state}",
    subtitle = "Money spent by different countries (in millions USD)"
  )+
  scale_fill_continuous(type = "viridis", limits = c(0, 15))+
  #rcartocolor::scale_fill_carto_c(palette = "BuGn")+
  guides(fill = guide_legend(title =  "Millions (USD)", 
                             label.position = "bottom",
                             title.position = "top",
                             nrow = 1))+
  theme(legend.position = "bottom")
  
  
```

\
\ Not surprisingly, it is USA who spent of lot of money for treating all diseases, especially between 2005-2010.

# Part5: Interactive chloropeth map for year 2015

```{r}

library(tmap)

tmap_mode("view") # make interactive

tm_shape(dQ3) + 
  tm_fill("expenditure_alldiseases_millions", 
          title = "Millions (USD)", 
          style = "quantile",
        palette = "-viridis")+
tm_layout("Expenditure of all diseases",
          legend.title.size = 1,
          legend.text.size = 0.6,
          legend.position = c("right","top"))
       
```

\
\ 
Looking at the expenditure date for year 2015, it looks that maxium expenditure was done by North America, followed by Europe. There was least expenditure (close to 0), from africa, south asia and south america. It is pointless to look at Antartica. 


# Part6: Spending by one continent: Europe for year 2015

```{r}

library(patchwork)

europe_cropped <- st_crop(world, xmin = -28, xmax = 62, ymin = 35, ymax = 69)

europe_bb <- st_bbox(c(xmin = -28, 
                       xmax = 62, 
                       ymax = 69, 
                       ymin = 35),
        crs = st_crs(4326)) %>% 
  st_as_sfc() %>% 
  st_transform(crs= 'ESRI:54030') %>% 
  st_bbox()

europe_cropped <- europe_cropped %>% 
  mutate(name_sort = case_when(name_sort == "Macedonia, FYR" ~ "North Macedonia",
         name_sort=="Slovak Republic" ~ "Slovakia",
         TRUE ~ as.character(name_sort)))

data_Q6_Europe <-europe_cropped  %>%
  left_join(spending_long_alldiseases_recipient, c("iso_a3"="recipient_isocode"))  

europe_rectangle <- world %>% 
  filter(continent == "Europe") %>% 
  filter(!sovereignt== "Russia") %>% 
  st_transform(crs = 'ESRI:54030') %>% 
  st_bbox() %>% 
  st_as_sfc() %>% 
  st_buffer(30000)

  
europe_inset_map <- ggplot() + 
  geom_sf(data = world, 
          fill = "white",
          size = 0.3,
          colour = "lightgrey") + 
  geom_sf(data = europe_rectangle, 
          fill = NA, 
          color = "magenta", 
          size = 0.8) +
  theme_void() 

world_somerc<-world %>% 
  st_transform(world, crs=2056)

europe_bb<-world_somerc %>% 
  filter(continent == "Europe") %>% 
  filter(!sovereignt== "Russia") %>% 
  st_bbox() %>% 
  st_as_sfc() %>% 
  st_buffer(30000) %>% 
  st_bbox()

europe_map <- ggplot() + 
  geom_sf(data = world_somerc, colour = "lightgrey",
          fill = "transparent",
          size = 0.5)+
  geom_sf(data = data_Q6_Europe,  # how to get this
    aes(fill = expenditure_alldiseases_millions),
    size = 0.2)+
    scale_fill_continuous(type = "viridis", limits = c(0, 0.2))+
  theme_void() +
  coord_sf(xlim = st_bbox(europe_bb)[c(1, 3)],
           ylim = st_bbox(europe_bb)[c(2, 4)]) +
  labs(title = "Average per capita yearly income by district, in 2018")+
  guides(fill = guide_legend(title = "", 
                             label.position = "bottom",
                             title.position = "top",
                             nrow = 1))+
  theme(legend.position = "bottom") +
  theme(plot.title = element_text(colour = "darkgrey"))

plot_europe <- ggplot() +
  coord_sf() +
  geom_sf(data = data_Q6_Europe,
          aes(fill = expenditure_alldiseases_millions))+ 
  scale_fill_continuous(type = "viridis", limits = c(0, 0.2)) +
  labs(title = "Dollars spent by Europe continent in treating all diseases for year 2015",
       caption = "Source: IHME Development Assistance for Health Database") + 
  guides(fill = guide_legend(title = 'Millions (USD)'))

layout <- c(
  patchwork::area(t = 1, l = 1, b = 7, r = 9),
  patchwork::area(t = 1, l = 0, b = 6, r = 3)
)
       
```
\ 
\ 

```{r}
plot_europe + europe_inset_map + 
  plot_layout(design = layout)
```
  
\ 
\
One country, Ukraine in Europe seemed to have spent the most amount of money for year 2015.

# Part7: Plotting  using SITG shapefiles and 3 different layers


```{r}

library(sf)
library(raster)

sitg<- st_read("data/sitg/CAD_BATIMENT_HORSOL_TOIT_SP.shp") %>%
  janitor::clean_names()
# 
osmbb <-  tmaptools::bb(sitg, ext=1.1)
# 

osmtiles <- tmaptools::read_osm(osmbb, type="opencyclemap") 

# data(World, metro, rivers, land)

# tmap_mode("plot")
# ## tmap mode set to plotting
# tm_shape(land) +
#     tm_raster("elevation", palette = terrain.colors(10)) +
# tm_shape(World) +
#     tm_borders("white", lwd = .5) +
#     tm_text("iso_a3", size = "AREA") +
# tm_shape(metro) +
#     tm_symbols(col = "red", size = "pop2020", scale = .5) 

tmap_mode("plot")
tm_shape(osmtiles) +
  tm_rgb() +
  tm_shape(sitg) +
  tm_polygons("altitude_m",
              style = "quantile",
              palette = "RdYlGn",
              alpha = 0.6) +
  tm_shape(sitg) +
  tm_bubbles(size = "shape_area", col = "darkred", alpha = 0.01)+
  tm_shape(sitg) +
    tm_symbols(col = "blue", label = "egid", alpha = 0.01) 

```

# Part8: City plot using OpenStreetMap

```{r}

opq_zurich<-opq(c(8.448006, 47.320220,  8.625441,  47.434666))

highway_motorway <- opq_zurich %>%
  add_osm_feature(key = "highway", value = "motorway") %>%
  osmdata_sf() %>%
  unname_osmdata_sf() %>%
  purrr::pluck("osm_lines")

highway_secondary <- opq_zurich %>%
  add_osm_feature(key = "highway", value = "secondary") %>%
  osmdata_sf() %>%
  unname_osmdata_sf() %>%
  purrr::pluck("osm_lines")

highway_primary <- opq_zurich %>%
  add_osm_feature(key = "highway", value = "primary") %>%
  osmdata_sf() %>%
  unname_osmdata_sf() %>%
  purrr::pluck("osm_lines")

highway_tertiary <- opq_zurich %>%
  add_osm_feature(key = "highway", value = "tertiary") %>%
  osmdata_sf() %>%
  unname_osmdata_sf() %>%
  purrr::pluck("osm_lines")

lakes <- opq_zurich %>%
  add_osm_feature(key = "natural", value = "water") %>%
  osmdata_sf() %>%
  unname_osmdata_sf() %>%
  purrr::pluck("osm_multipolygons")

streets<-opq_zurich %>%
  add_osm_feature(
    key = "highway",
    value = c(
      "motorway", "primary",
      "secondary", "tertiary"
    )
  ) %>%
  osmdata_sf() %>%
  purrr::pluck("osm_lines")

small_streets <- opq_zurich %>%
  add_osm_feature(
    key = "highway",
    value = c(
      "residential", "living_street",
      "unclassified",
      "service", "footway"
    )
  ) %>%
  osmdata_sf() %>%
  purrr::pluck("osm_lines")

river <- opq_zurich %>%
add_osm_feature(key = 'waterway', value = 'river') %>%
osmdata_sf() %>%
purrr::pluck('osm_lines')

  ggplot() +
  geom_sf(data = streets, color = "#bdbdbd", show.legend = "line") +
  geom_sf(data = small_streets, color = "#d9d9d9", alpha = 0.6,show.legend ="line") +
  geom_sf(data = river,  color = "#d0d1e6", size = 1) +
  geom_sf(data = lakes, fill = "blue", color = "blue",alpha = 0.2) +
  geom_sf(data = highway_motorway,  color = "orange",alpha = 0.6) +
  geom_sf(data = highway_primary,  color = "pink",alpha = 0.6) +
  geom_sf(data = highway_tertiary,  color = "brown",alpha = 0.6) +
  geom_sf(data = highway_secondary,  color = "cyan",alpha = 0.6) +
  #theme_void() +
  coord_sf(
    xlim = c(8.448006, 8.625441),
    ylim = c(47.320220, 47.434666),
    expand = FALSE
  )+
  theme(
    plot.background = element_rect(fill = "#F9F8F5"),
    panel.border = element_blank(),
    legend.position = "bottom"
  ) +xlab("Latitude")+ylab("Longitude")+
     labs(title="Distribution of different highways, streets, rivers, lakes in Zurich")+
  guides(fill = guide_legend(override.aes = list(color = "black"))) +
  scale_color_identity(guide = "legend")
  
```


